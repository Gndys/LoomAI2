# è®¤è¯ä¸­é—´ä»¶è®¾è®¡æ–‡æ¡£

æœ¬æ–‡æ¡£è¯¦ç»†ä»‹ç» TinyShip é¡¹ç›®ä¸­è®¤è¯ä¸­é—´ä»¶çš„è®¾è®¡å’Œä½¿ç”¨æ–¹å¼ï¼Œå½“å‰ä»…åŒ…å« Next.js å®ç°æ–¹æ¡ˆã€‚

## ğŸ“‹ ç›®å½•

1. [æ¦‚è¿°](#æ¦‚è¿°)
2. [æ¶æ„è®¾è®¡](#æ¶æ„è®¾è®¡)
3. [Next.js è®¤è¯ä¸­é—´ä»¶](#nextjs-è®¤è¯ä¸­é—´ä»¶)
4. [è·¯ç”±ä¿æŠ¤é…ç½®](#è·¯ç”±ä¿æŠ¤é…ç½®)
5. [æƒé™æ£€æŸ¥æœºåˆ¶](#æƒé™æ£€æŸ¥æœºåˆ¶)
6. [è®¢é˜…éªŒè¯](#è®¢é˜…éªŒè¯)
7. [ä½¿ç”¨æŒ‡å—](#ä½¿ç”¨æŒ‡å—)
8. [æœ€ä½³å®è·µ](#æœ€ä½³å®è·µ)

## æ¦‚è¿°

TinyShip æä¾›äº†ç»Ÿä¸€çš„è®¤è¯ä¸­é—´ä»¶è®¾è®¡ï¼Œæ”¯æŒï¼š

- **å¤šå±‚è®¤è¯æ£€æŸ¥** - èº«ä»½éªŒè¯ã€æƒé™éªŒè¯ã€è®¢é˜…éªŒè¯
- **æ¡†æ¶é€‚é…** - Next.js å®ç°
- **é…ç½®é©±åŠ¨** - é€šè¿‡è·¯ç”±é…ç½®æ§åˆ¶è®¿é—®æƒé™
- **æ€§èƒ½ä¼˜åŒ–** - æ™ºèƒ½é‡å®šå‘å’Œç¼“å­˜æœºåˆ¶

### æ ¸å¿ƒç‰¹æ€§

âœ… **ç»Ÿä¸€é…ç½®** - ä½¿ç”¨ç»Ÿä¸€çš„è·¯ç”±ä¿æŠ¤é…ç½®  
âœ… **åˆ†å±‚éªŒè¯** - èº«ä»½è®¤è¯ â†’ æƒé™æ£€æŸ¥ â†’ è®¢é˜…éªŒè¯  
âœ… **æ™ºèƒ½é‡å®šå‘** - æ ¹æ®ç”¨æˆ·çŠ¶æ€è‡ªåŠ¨è·³è½¬åˆ°åˆé€‚é¡µé¢  
âœ… **å›½é™…åŒ–æ”¯æŒ** - è‡ªåŠ¨å¤„ç†å¤šè¯­è¨€è·¯ç”±  
âœ… **å¼€å‘å‹å¥½** - è¯¦ç»†çš„æ—¥å¿—è¾“å‡ºå’Œé”™è¯¯æç¤º  

## æ¶æ„è®¾è®¡

### ä¸‰å±‚éªŒè¯æ¨¡å‹

```mermaid
flowchart TD
    A[ç”¨æˆ·è¯·æ±‚] --> B{è·¯ç”±åŒ¹é…}
    B -->|åŒ¹é…ä¿æŠ¤è·¯ç”±| C[ç¬¬ä¸€å±‚ï¼šèº«ä»½è®¤è¯]
    B -->|å…¬å¼€è·¯ç”±| Z[å…è®¸è®¿é—®]
    
    C --> D{å·²ç™»å½•?}
    D -->|å¦| E[é‡å®šå‘åˆ°ç™»å½•]
    D -->|æ˜¯| F[ç¬¬äºŒå±‚ï¼šæƒé™æ£€æŸ¥]
    
    F --> G{æœ‰æƒé™?}
    G -->|å¦| H[403 ç¦æ­¢è®¿é—®]
    G -->|æ˜¯| I[ç¬¬ä¸‰å±‚ï¼šè®¢é˜…éªŒè¯]
    
    I --> J{éœ€è¦è®¢é˜…?}
    J -->|å¦| Z
    J -->|æ˜¯| K{æœ‰æœ‰æ•ˆè®¢é˜…?}
    K -->|å¦| L[é‡å®šå‘åˆ°å®šä»·é¡µ]
    K -->|æ˜¯| Z[å…è®¸è®¿é—®]
```

## Next.js è®¤è¯ä¸­é—´ä»¶

### æ–‡ä»¶ç»“æ„

```bash
apps/next-app/
â”œâ”€â”€ middleware.ts                 # ä¸»ä¸­é—´ä»¶å…¥å£
â””â”€â”€ middlewares/
    â”œâ”€â”€ authMiddleware.ts        # è®¤è¯é€»è¾‘
    â”œâ”€â”€ localeMiddleware.ts      # å›½é™…åŒ–å¤„ç†
```

### å·¥ä½œæµç¨‹

1. **è¯·æ±‚æ‹¦æˆª** - `middleware.ts` æ‹¦æˆªæ‰€æœ‰é¡µé¢è¯·æ±‚
2. **è·¯ç”±åŒ¹é…** - æ£€æŸ¥æ˜¯å¦ä¸ºä¿æŠ¤è·¯ç”±
3. **èº«ä»½éªŒè¯** - ä½¿ç”¨ Better Auth éªŒè¯ç”¨æˆ·ä¼šè¯
4. **æƒé™æ£€æŸ¥** - åŸºäº RBAC ç³»ç»ŸéªŒè¯ç”¨æˆ·æƒé™
5. **è®¢é˜…éªŒè¯** - æ£€æŸ¥ç”¨æˆ·è®¢é˜…çŠ¶æ€ï¼ˆå¦‚éœ€è¦ï¼‰
6. **æ™ºèƒ½é‡å®šå‘** - æ ¹æ®éªŒè¯ç»“æœè¿›è¡Œç›¸åº”å¤„ç†

### é…ç½®ç¤ºä¾‹

```typescript
// ç®¡ç†å‘˜é¡µé¢ - éœ€è¦ç®¡ç†æƒé™
{
  pattern: new RegExp(`^\\/(${i18n.locales.join('|')})\\/admin(\\/.*)?$`),
  type: 'page',
  requiresAuth: true,
  requiredPermission: { action: Action.MANAGE, subject: Subject.ALL }
},

// é«˜çº§åŠŸèƒ½ - éœ€è¦æœ‰æ•ˆè®¢é˜…
{
  pattern: new RegExp(`^\\/(${i18n.locales.join('|')})\\/premium-features(\\/.*)?$`),
  type: 'page',
  requiresAuth: true,
  requiresSubscription: true
},

// è®¤è¯é¡µé¢ - å·²ç™»å½•ç”¨æˆ·é‡å®šå‘
{
  pattern: new RegExp(`^\\/(${i18n.locales.join('|')})\\/signin$`),
  type: 'page',
  requiresAuth: false,
  isAuthRoute: true
}
```

### ä½¿ç”¨æ–¹å¼

ä¸­é—´ä»¶ä¼šè‡ªåŠ¨å¤„ç†æ‰€æœ‰ä¿æŠ¤é€»è¾‘ï¼Œå¼€å‘è€…åªéœ€ï¼š

1. **é…ç½®è·¯ç”±** - åœ¨ `protectedRoutes` æ•°ç»„ä¸­æ·»åŠ è·¯ç”±é…ç½®
2. **åˆ›å»ºé¡µé¢** - æ­£å¸¸åˆ›å»ºé¡µé¢ç»„ä»¶ï¼Œä¸­é—´ä»¶ä¼šè‡ªåŠ¨å¤„ç†æƒé™æ£€æŸ¥

## è·¯ç”±ä¿æŠ¤é…ç½®

### é…ç½®é€‰é¡¹è¯¦è§£

| é€‰é¡¹ | ä½œç”¨ | ç¤ºä¾‹åœºæ™¯ |
|------|------|----------|
| `pattern` | åŒ¹é…éœ€è¦ä¿æŠ¤çš„è·¯ç”± | `/admin` åŒ¹é…ç®¡ç†å‘˜é¡µé¢ |
| `type` | åŒºåˆ†é¡µé¢å’ŒAPIï¼Œå†³å®šå¤±è´¥æ—¶çš„å“åº”æ–¹å¼ | é¡µé¢é‡å®šå‘ï¼ŒAPIè¿”å›é”™è¯¯ç  |
| `requiresAuth` | æ˜¯å¦å¿…é¡»ç™»å½•æ‰èƒ½è®¿é—® | ä»ªè¡¨æ¿é¡µé¢éœ€è¦ç™»å½• |
| `requiredPermission` | éœ€è¦ç‰¹å®šæƒé™æ‰èƒ½è®¿é—® | ç®¡ç†å‘˜é¡µé¢éœ€è¦ç®¡ç†æƒé™ |
| `requiresSubscription` | æ˜¯å¦éœ€è¦æœ‰æ•ˆè®¢é˜… | é«˜çº§åŠŸèƒ½éœ€è¦ä»˜è´¹è®¢é˜… |
| `isAuthRoute` | å·²ç™»å½•ç”¨æˆ·è®¿é—®æ—¶é‡å®šå‘åˆ°ä»ªè¡¨æ¿ | ç™»å½•é¡µé¢ï¼Œæ³¨å†Œé¡µé¢ |
| `redirectIfSubscribed` | å·²è®¢é˜…ç”¨æˆ·è®¿é—®æ—¶é‡å®šå‘åˆ°ä»ªè¡¨æ¿ | å®šä»·é¡µé¢ |

### å¸¸è§é…ç½®æ¨¡å¼

#### 1. å…¬å¼€é¡µé¢

```typescript
// æ— éœ€ä»»ä½•éªŒè¯
// ä¸åœ¨ protectedRoutes ä¸­é…ç½®å³å¯
```

#### 2. éœ€è¦ç™»å½•çš„é¡µé¢

```typescript
{
  pattern: /^\/dashboard$/,
  type: 'page',
  requiresAuth: true
}
```

#### 3. ç®¡ç†å‘˜ä¸“ç”¨é¡µé¢

```typescript
{
  pattern: /^\/admin/,
  type: 'page',
  requiresAuth: true,
  requiredPermission: { action: Action.MANAGE, subject: Subject.ALL }
}
```

#### 4. ä»˜è´¹åŠŸèƒ½é¡µé¢

```typescript
{
  pattern: /^\/premium/,
  type: 'page',
  requiresAuth: true,
  requiresSubscription: true
}
```

#### 5. è®¤è¯é¡µé¢ï¼ˆå·²ç™»å½•é‡å®šå‘ï¼‰

```typescript
{
  pattern: /^\/signin$/,
  type: 'page',
  requiresAuth: false,
  isAuthRoute: true  // å·²ç™»å½•ç”¨æˆ·è®¿é—®æ—¶é‡å®šå‘åˆ°ä»ªè¡¨æ¿
}
```

#### 6. å®šä»·é¡µé¢ï¼ˆå·²ä»˜è´¹é‡å®šå‘ï¼‰

```typescript
{
  pattern: /^\/pricing$/,
  type: 'page',
  requiresAuth: false,
  redirectIfSubscribed: true  // å·²è®¢é˜…ç”¨æˆ·é‡å®šå‘åˆ°ä»ªè¡¨æ¿
}
```

## æƒé™æ£€æŸ¥æœºåˆ¶

### RBAC æƒé™æ¨¡å‹

TinyShip ä½¿ç”¨åŸºäºè§’è‰²çš„è®¿é—®æ§åˆ¶ï¼ˆRBACï¼‰ï¼š

```typescript
// æƒé™æ£€æŸ¥ç¤ºä¾‹
can(user, Action.MANAGE, Subject.ALL)  // ç®¡ç†æ‰€æœ‰èµ„æº
can(user, Action.READ, Subject.USER)   // è¯»å–ç”¨æˆ·ä¿¡æ¯
can(user, Action.CREATE, Subject.ORDER) // åˆ›å»ºè®¢å•
```


## ä½¿ç”¨æŒ‡å—

### æ·»åŠ æ–°çš„ä¿æŠ¤è·¯ç”±

#### 1. ç¡®å®šä¿æŠ¤çº§åˆ«
- **ä»…éœ€ç™»å½•** - è®¾ç½® `requiresAuth: true`
- **éœ€è¦ç‰¹å®šæƒé™** - æ·»åŠ  `requiredPermission`
- **éœ€è¦ä»˜è´¹è®¢é˜…** - è®¾ç½® `requiresSubscription: true`

#### 2. åœ¨ protectedRoutes æ•°ç»„ä¸­æ·»åŠ é…ç½®

```typescript
{
  pattern: new RegExp(`^\\/(${locales.join('|')})\\/your-feature(\\/.*)?$`),
  type: 'page',
  requiresAuth: true,
  requiresSubscription: true  // å¦‚æœæ˜¯ä»˜è´¹åŠŸèƒ½
}
```

#### 3. åˆ›å»ºå¯¹åº”çš„é¡µé¢
åˆ›å»ºé¡µé¢åï¼Œä¸­é—´ä»¶ä¼šè‡ªåŠ¨æ ¹æ®é…ç½®è¿›è¡Œæƒé™æ£€æŸ¥å’Œé‡å®šå‘ã€‚

## æœ€ä½³å®è·µ

### é…ç½®å»ºè®®

- **æœ€å°æƒé™** - åªæˆäºˆå¿…éœ€çš„æœ€å°æƒé™
- **ç»Ÿä¸€é…ç½®** - å°†æ‰€æœ‰è·¯ç”±ä¿æŠ¤è§„åˆ™é›†ä¸­åœ¨ `protectedRoutes` æ•°ç»„ä¸­
- **ç±»å‹å®‰å…¨** - ä½¿ç”¨ TypeScript ç¡®ä¿é…ç½®æ­£ç¡®
- **æµ‹è¯•éªŒè¯** - é…ç½®åæµ‹è¯•å„ç§ç”¨æˆ·çŠ¶æ€ä¸‹çš„è®¿é—®æƒ…å†µ

### æƒé™è®¾è®¡

- **åˆ†å±‚éªŒè¯** - ä¸­é—´ä»¶å¤„ç†é€šç”¨æƒé™ï¼Œé¡µé¢å†…å¤„ç†å…·ä½“ä¸šåŠ¡æƒé™
- **æœåŠ¡ç«¯ä¼˜å…ˆ** - é‡è¦æƒé™æ£€æŸ¥åœ¨æœåŠ¡ç«¯è¿›è¡Œ
- **æ¸…æ™°é‡å®šå‘** - æ ¹æ®ç”¨æˆ·çŠ¶æ€æ™ºèƒ½é‡å®šå‘åˆ°åˆé€‚é¡µé¢

## æ€»ç»“

TinyShip çš„è®¤è¯ä¸­é—´ä»¶è®¾è®¡æä¾›äº†ï¼š

- **ç»Ÿä¸€ä½“éªŒ** - ä¿æŒä¸€è‡´çš„æƒé™æ¨¡å‹
- **çµæ´»é…ç½®** - æ”¯æŒå„ç§æƒé™æ§åˆ¶éœ€æ±‚
- **é«˜æ€§èƒ½** - ä¼˜åŒ–çš„æ£€æŸ¥æµç¨‹å’Œç¼“å­˜ç­–ç•¥
- **å®‰å…¨å¯é ** - å¤šå±‚éªŒè¯ç¡®ä¿ç³»ç»Ÿå®‰å…¨
- **å¼€å‘å‹å¥½** - ç®€å•çš„é…ç½®å’Œæ¸…æ™°çš„æ–‡æ¡£

é€šè¿‡åˆç†é…ç½®å’Œä½¿ç”¨è®¤è¯ä¸­é—´ä»¶ï¼Œæ‚¨å¯ä»¥å¿«é€Ÿæ„å»ºå®‰å…¨ã€é«˜æ•ˆçš„ SaaS åº”ç”¨ç¨‹åºã€‚
